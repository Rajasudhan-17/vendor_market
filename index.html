<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VendorConnect - Street Vendor Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .location-info {
            background: #e8f5e8;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            color: #2d5a2d;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .search-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            border-color: #667eea;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: transparent;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .suppliers-list {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .supplier-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .supplier-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .supplier-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .supplier-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .trust-score {
            background: #4CAF50;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .supplier-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .product-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .product-price {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .quantity-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }

        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }

        .add-to-cart-btn {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .map-sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 400px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .cart-section {
            margin-top: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .cart-total {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
        }

        .checkout-btn {
            width: 100%;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: #667eea;
        }

        .rating {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .star.active {
            color: #ffc107;
        }

        .orders-history {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .order-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .order-id {
            font-weight: bold;
            color: #2c3e50;
        }

        .order-status {
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .auth-section {
                flex-direction: column;
                gap: 15px;
            }
            
            .filters {
                justify-content: center;
            }
            
            .supplier-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛒 VendorConnect</h1>
            <div class="auth-section">
                <div class="user-info">
                    <div class="location-info" id="locationInfo">📍 Getting location...</div>
                    <div id="userProfile">
                        <span id="userName">Guest</span>
                        <button class="btn" onclick="showLoginModal()">Login</button>
                    </div>
                </div>
                <button class="btn" onclick="redirectToOrderHistory()">Order History</button>
            </div>
        </div>

        <div class="search-section">
            <input type="text" class="search-box" id="searchBox" placeholder="🔍 Search for products, suppliers..." oninput="filterProducts()">
            <div class="filters">
                <button class="filter-btn active" onclick="filterByCategory('')">All</button>
                <button class="filter-btn" onclick="filterByCategory('vegetables')">Vegetables</button>
                <button class="filter-btn" onclick="filterByCategory('fruits')">Fruits</button>
                <button class="filter-btn" onclick="filterByCategory('grains')">Grains</button>
                <button class="filter-btn" onclick="filterByCategory('dairy')">Dairy</button>
            </div>
        </div>

        <div class="main-content">
            <div class="suppliers-list" id="suppliersList">
                <!-- Suppliers will be loaded here -->
            </div>

            <div class="map-sidebar">
                <div id="map"></div>
                <div class="cart-section">
                    <h3>🛒 Your Cart</h3>
                    <div id="cartItems"></div>
                    <div class="cart-total" id="cartTotal">
                        <div>Total: ₹0</div>
                        <div>Delivery: ₹0</div>
                        <div><strong>Final Total: ₹0</strong></div>
                    </div>
                    <button class="checkout-btn" onclick="checkout()">Checkout</button>
                </div>
            </div>
        </div>

        <div class="orders-history" id="ordersHistory" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>📋 Order History</h2>
                <button class="btn" onclick="goBackToMain()">← Back to Shop</button>
            </div>
            <div id="ordersList"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2>Login to VendorConnect</h2>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="loginEmail" value="vendor@example.com">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="loginPassword" value="password123">
            </div>
            <button class="btn" onclick="login()" style="width: 100%;">Login</button>
            <p style="margin-top: 15px; text-align: center; color: #666;">
                Default credentials: vendor@example.com / password123
            </p>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('reviewModal')">&times;</span>
            <h2>Rate Supplier</h2>
            <div class="form-group">
                <label>Rating:</label>
                <div class="rating" id="ratingStars">
                    <span class="star" onclick="setRating(1)">⭐</span>
                    <span class="star" onclick="setRating(2)">⭐</span>
                    <span class="star" onclick="setRating(3)">⭐</span>
                    <span class="star" onclick="setRating(4)">⭐</span>
                    <span class="star" onclick="setRating(5)">⭐</span>
                </div>
            </div>
            <div class="form-group">
                <label>Review:</label>
                <textarea id="reviewText" rows="4" placeholder="Share your experience..."></textarea>
            </div>
            <button class="btn" onclick="submitReview()" style="width: 100%;">Submit Review</button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('checkoutModal')">&times;</span>
            <h2>Checkout</h2>
            <div id="checkoutDetails"></div>
            <div class="form-group">
                <label>Delivery Address:</label>
                <textarea id="deliveryAddress" rows="3" placeholder="Enter your delivery address..."></textarea>
            </div>
            <div class="form-group">
                <label>Payment Method:</label>
                <select id="paymentMethod">
                    <option value="cod">Cash on Delivery</option>
                    <option value="upi">UPI Payment</option>
                    <option value="card">Credit/Debit Card</option>
                </select>
            </div>
            <button class="btn" onclick="confirmOrder()" style="width: 100%;">Confirm Order</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let userLocation = null;
        let suppliers = [];
        let cart = [];
        let currentUser = null;
        let orders = [];
        let currentRating = 0;
        let currentSupplierId = null;

        // Sample data
        const sampleSuppliers = [
            {
                id: 1,
                name: "Fresh Farms Supply",
                location: { lat: 13.0827, lng: 80.2707 },
                distance: 1.2,
                trustScore: 4.8,
                reviews: 156,
                deliveryCharge: 25,
                products: [
                    { id: 1, name: "Tomatoes", price: 40, category: "vegetables", unit: "kg" },
                    { id: 2, name: "Onions", price: 35, category: "vegetables", unit: "kg" },
                    { id: 3, name: "Potatoes", price: 30, category: "vegetables", unit: "kg" }
                ]
            },
            {
                id: 2,
                name: "Organic Greens",
                location: { lat: 13.0878, lng: 80.2785 },
                distance: 2.1,
                trustScore: 4.6,
                reviews: 89,
                deliveryCharge: 35,
                products: [
                    { id: 4, name: "Spinach", price: 25, category: "vegetables", unit: "bunch" },
                    { id: 5, name: "Lettuce", price: 20, category: "vegetables", unit: "piece" },
                    { id: 6, name: "Carrots", price: 45, category: "vegetables", unit: "kg" }
                ]
            },
            {
                id: 3,
                name: "Fruit Paradise",
                location: { lat: 13.0758, lng: 80.2644 },
                distance: 2.8,
                trustScore: 4.9,
                reviews: 203,
                deliveryCharge: 40,
                products: [
                    { id: 7, name: "Bananas", price: 50, category: "fruits", unit: "dozen" },
                    { id: 8, name: "Apples", price: 120, category: "fruits", unit: "kg" },
                    { id: 9, name: "Oranges", price: 80, category: "fruits", unit: "kg" }
                ]
            }
        ];

        // Initialize the application
        function initApp() {
            loadSuppliers();
            loadCartFromStorage();
            loadOrdersFromStorage();
            handleReorderItems();
            displaySuppliers(); // Show suppliers immediately
            initMap();
            getUserLocation(); // Get location in background
        }

        // Get user's current location
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateLocationInfo();
                        updateSupplierDistances();
                        displaySuppliers();
                        updateMapMarkers();
                    },
                    (error) => {
                        console.log("Location access denied, using default location");
                        userLocation = { lat: 13.0827, lng: 80.2707 }; // Default to Chennai
                        updateLocationInfo();
                        updateSupplierDistances();
                        displaySuppliers();
                        updateMapMarkers();
                    }
                );
            } else {
                // Fallback for browsers without geolocation
                userLocation = { lat: 13.0827, lng: 80.2707 };
                updateLocationInfo();
                updateSupplierDistances();
                displaySuppliers();
                updateMapMarkers();
            }
        }

        // Update location info display
        function updateLocationInfo() {
            const locationElement = document.getElementById('locationInfo');
            if (userLocation) {
                locationElement.textContent = 
                    `📍 Chennai, Tamil Nadu (${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)})`;
            } else {
                locationElement.textContent = '📍 Getting location...';
            }
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Update supplier distances based on user location
        function updateSupplierDistances() {
            if (!userLocation) return;
            
            suppliers.forEach(supplier => {
                supplier.distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    supplier.location.lat, supplier.location.lng
                );
                supplier.deliveryCharge = Math.max(20, Math.round(supplier.distance * 15));
            });

            // Sort by distance
            suppliers.sort((a, b) => a.distance - b.distance);
        }

        // Load suppliers data
        function loadSuppliers() {
            suppliers = [...sampleSuppliers];
        }

        // Display suppliers - FIXED VERSION
        function displaySuppliers(filteredSuppliers = null) {
            const suppliersToShow = filteredSuppliers || suppliers;
            const container = document.getElementById('suppliersList');
            
            if (suppliersToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>No suppliers found</h3>
                        <p>Try adjusting your search or filters</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = suppliersToShow.map(supplier => `
                <div class="supplier-card" data-supplier-id="${supplier.id}">
                    <div class="supplier-header">
                        <div class="supplier-name">${supplier.name}</div>
                        <div class="trust-score">⭐ ${supplier.trustScore} (${supplier.reviews})</div>
                    </div>
                    <div class="supplier-info">
                        <div>📍 ${supplier.distance ? supplier.distance.toFixed(1) + ' km away' : 'Calculating distance...'}</div>
                        <div>🚚 Delivery: ₹${supplier.deliveryCharge}</div>
                    </div>
                    <button class="btn" onclick="showReviewModal(${supplier.id})" style="margin-bottom: 15px;">Rate Supplier</button>
                    <div class="products-grid">
                        ${supplier.products.map(product => `
                            <div class="product-card">
                                <div class="product-name">${product.name}</div>
                                <div class="product-price">₹${product.price}/${product.unit}</div>
                                <div class="quantity-controls">
                                    <button class="quantity-btn" onclick="changeQuantity(${product.id}, -1)">-</button>
                                    <input type="number" class="quantity-input" id="qty-${product.id}" value="1" min="1">
                                    <button class="quantity-btn" onclick="changeQuantity(${product.id}, 1)">+</button>
                                </div>
                                <button class="add-to-cart-btn" onclick="addToCart(${supplier.id}, ${product.id})">
                                    Add to Cart
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([13.0827, 80.2707], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Show suppliers on map immediately
            updateMapMarkers();
        }

        // Update map markers
        function updateMapMarkers() {
            if (!map) return;

            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Add user location marker if available
            if (userLocation) {
                L.marker([userLocation.lat, userLocation.lng])
                    .addTo(map)
                    .bindPopup('Your Location')
                    .openPopup();
                    
                // Set map view to user location
                map.setView([userLocation.lat, userLocation.lng], 13);
            }

            // Add supplier markers
            suppliers.forEach(supplier => {
                L.marker([supplier.location.lat, supplier.location.lng])
                    .addTo(map)
                    .bindPopup(`
                        <b>${supplier.name}</b><br>
                        ${supplier.distance ? `Distance: ${supplier.distance.toFixed(1)} km<br>` : ''}
                        Trust Score: ⭐ ${supplier.trustScore}<br>
                        Delivery: ₹${supplier.deliveryCharge}
                    `);
            });
        }

        // Filter products
        function filterProducts() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            if (!searchTerm.trim()) {
                displaySuppliers();
                return;
            }
            
            const filteredSuppliers = suppliers.filter(supplier => {
                const matchesSupplier = supplier.name.toLowerCase().includes(searchTerm);
                const matchesProduct = supplier.products.some(product => 
                    product.name.toLowerCase().includes(searchTerm)
                );
                return matchesSupplier || matchesProduct;
            });

            displaySuppliers(filteredSuppliers);
        }

        // Filter by category
        function filterByCategory(category) {
            // Update filter button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (!category) {
                displaySuppliers();
                return;
            }

            const filteredSuppliers = suppliers.filter(supplier => {
                return supplier.products.some(product => product.category === category);
            });

            displaySuppliers(filteredSuppliers);
        }

        // Change quantity
        function changeQuantity(productId, change) {
            const input = document.getElementById(`qty-${productId}`);
            if (input) {
                const newValue = Math.max(1, parseInt(input.value || 1) + change);
                input.value = newValue;
            }
        }

        // Add to cart
        function addToCart(supplierId, productId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            const product = supplier.products.find(p => p.id === productId);
            const quantityInput = document.getElementById(`qty-${productId}`);
            const quantity = parseInt(quantityInput ? quantityInput.value : 1);

            const existingItem = cart.find(item => item.productId === productId && item.supplierId === supplierId);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    productId,
                    supplierId,
                    productName: product.name,
                    supplierName: supplier.name,
                    price: product.price,
                    unit: product.unit,
                    quantity,
                    deliveryCharge: supplier.deliveryCharge
                });
            }

            updateCartDisplay();
            saveCartToStorage();
            
            // Show success message
            alert(`${product.name} added to cart!`);
        }

        // Update cart display
        function updateCartDisplay() {
            const cartContainer = document.getElementById('cartItems');
            const cartTotalContainer = document.getElementById('cartTotal');

            if (cart.length === 0) {
                cartContainer.innerHTML = '<p>Your cart is empty</p>';
                cartTotalContainer.innerHTML = `
                    <div>Total: ₹0</div>
                    <div>Delivery: ₹0</div>
                    <div><strong>Final Total: ₹0</strong></div>
                `;
                return;
            }

            cartContainer.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div>
                        <strong>${item.productName}</strong><br>
                        <small>${item.supplierName} - ₹${item.price}/${item.unit}</small>
                    </div>
                    <div>
                        ${item.quantity} × ₹${item.price} = ₹${item.quantity * item.price}
                        <button onclick="removeFromCart(${item.productId}, ${item.supplierId})" style="margin-left: 10px; background: red; color: white; border: none; border-radius: 3px; padding: 2px 6px;">×</button>
                    </div>
                </div>
            `).join('');

            const subtotal = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const deliveryCharges = [...new Set(cart.map(item => item.supplierId))]
                .reduce((sum, supplierId) => {
                    const supplier = suppliers.find(s => s.id === supplierId);
                    return sum + (supplier ? supplier.deliveryCharge : 0);
                }, 0);
            const total = subtotal + deliveryCharges;

            cartTotalContainer.innerHTML = `
                <div>Subtotal: ₹${subtotal}</div>
                <div>Delivery: ₹${deliveryCharges}</div>
                <div><strong>Total: ₹${total}</strong></div>
            `;
        }

        // Remove from cart
        function removeFromCart(productId, supplierId) {
            cart = cart.filter(item => !(item.productId === productId && item.supplierId === supplierId));
            updateCartDisplay();
            saveCartToStorage();
        }

        // Save cart to storage
        function saveCartToStorage() {
            try {
                // Store in both localStorage and window for compatibility
                if (typeof Storage !== "undefined") {
                    localStorage.setItem('vendorConnect_cart', JSON.stringify(cart));
                }
                window.cartData = cart;
            } catch (e) {
                console.log('Storage not available, using memory storage');
                window.cartData = cart;
            }
        }

        // Load cart from storage
        function loadCartFromStorage() {
            try {
                let savedCart = null;
                if (typeof Storage !== "undefined") {
                    savedCart = localStorage.getItem('vendorConnect_cart');
                    if (savedCart) {
                        cart = JSON.parse(savedCart);
                    }
                } else if (window.cartData) {
                    cart = window.cartData;
                }
                updateCartDisplay();
            } catch (e) {
                console.log('Could not load cart from storage');
            }
        }

        // Save orders to storage
        function saveOrdersToStorage() {
            try {
                // Store in both localStorage and window for compatibility
                if (typeof Storage !== "undefined") {
                    localStorage.setItem('vendorConnect_orders', JSON.stringify(orders));
                }
                window.ordersData = orders;
            } catch (e) {
                console.log('Storage not available, using memory storage');
                window.ordersData = orders;
            }
        }

        // Load orders from storage
        function loadOrdersFromStorage() {
            try {
                let savedOrders = null;
                if (typeof Storage !== "undefined") {
                    savedOrders = localStorage.getItem('vendorConnect_orders');
                    if (savedOrders) {
                        orders = JSON.parse(savedOrders);
                        return;
                    }
                }
                if (window.ordersData) {
                    orders = window.ordersData;
                }
            } catch (e) {
                console.log('Could not load orders from storage');
            }
        }

        // Show login modal
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Login function
        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Simple authentication (in real app, this would be server-side)
            if (email === 'vendor@example.com' && password === 'password123') {
                currentUser = {
                    id: 1,
                    name: 'Street Vendor',
                    email: email,
                    phone: '+91 9876543210'
                };
                
                document.getElementById('userName').textContent = currentUser.name;
                document.querySelector('#userProfile button').textContent = 'Logout';
                document.querySelector('#userProfile button').onclick = logout;
                
                closeModal('loginModal');
                alert('Login successful!');
            } else {
                alert('Invalid credentials. Use: vendor@example.com / password123');
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            document.getElementById('userName').textContent = 'Guest';
            document.querySelector('#userProfile button').textContent = 'Login';
            document.querySelector('#userProfile button').onclick = showLoginModal;
            alert('Logged out successfully!');
        }

        // Show review modal
        function showReviewModal(supplierId) {
            if (!currentUser) {
                alert('Please login to rate suppliers');
                return;
            }
            
            currentSupplierId = supplierId;
            document.getElementById('reviewModal').style.display = 'block';
            resetRating();
        }

        // Set rating
        function setRating(rating) {
            currentRating = rating;
            const stars = document.querySelectorAll('#ratingStars .star');
            stars.forEach((star, index) => {
                star.classList.toggle('active', index < rating);
            });
        }

        // Reset rating
        function resetRating() {
            currentRating = 0;
            document.querySelectorAll('#ratingStars .star').forEach(star => {
                star.classList.remove('active');
            });
            document.getElementById('reviewText').value = '';
        }

        // Submit review
        function submitReview() {
            if (!currentRating) {
                alert('Please select a rating');
                return;
            }

            const reviewText = document.getElementById('reviewText').value;
            const supplier = suppliers.find(s => s.id === currentSupplierId);
            
            if (supplier) {
                // In a real app, this would be sent to the server
                const newReviewCount = supplier.reviews + 1;
                const newTrustScore = ((supplier.trustScore * supplier.reviews) + currentRating) / newReviewCount;
                
                supplier.trustScore = Math.round(newTrustScore * 10) / 10;
                supplier.reviews = newReviewCount;
                
                // Re-sort suppliers by trust score and distance
                suppliers.sort((a, b) => {
                    if (Math.abs(a.distance - b.distance) < 0.5) {
                        return b.trustScore - a.trustScore;
                    }
                    return a.distance - b.distance;
                });
                
                displaySuppliers();
                closeModal('reviewModal');
                alert('Review submitted successfully!');
            }
        }

        // Checkout function
        function checkout() {
            if (!currentUser) {
                alert('Please login to checkout');
                return;
            }

            if (cart.length === 0) {
                alert('Your cart is empty');
                return;
            }

            const checkoutDetails = document.getElementById('checkoutDetails');
            const subtotal = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const deliveryCharges = [...new Set(cart.map(item => item.supplierId))]
                .reduce((sum, supplierId) => {
                    const supplier = suppliers.find(s => s.id === supplierId);
                    return sum + (supplier ? supplier.deliveryCharge : 0);
                }, 0);
            const total = subtotal + deliveryCharges;

            checkoutDetails.innerHTML = `
                <h3>Order Summary</h3>
                ${cart.map(item => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${item.productName} (${item.quantity} ${item.unit})</span>
                        <span>₹${item.quantity * item.price}</span>
                    </div>
                `).join('')}
                <hr>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Subtotal:</span>
                    <span>₹${subtotal}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Delivery Charges:</span>
                    <span>₹${deliveryCharges}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em;">
                    <span>Total:</span>
                    <span>₹${total}</span>
                </div>
            `;

            document.getElementById('checkoutModal').style.display = 'block';
        }

        // Confirm order
        function confirmOrder() {
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!deliveryAddress.trim()) {
                alert('Please enter delivery address');
                return;
            }

            const orderId = 'ORD' + Date.now().toString().substr(-8);
            const subtotal = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const deliveryCharges = [...new Set(cart.map(item => item.supplierId))]
                .reduce((sum, supplierId) => {
                    const supplier = suppliers.find(s => s.id === supplierId);
                    return sum + (supplier ? supplier.deliveryCharge : 0);
                }, 0);
            const total = subtotal + deliveryCharges;

            const order = {
                id: orderId,
                userId: currentUser.id,
                items: [...cart],
                subtotal,
                deliveryCharges,
                total,
                deliveryAddress,
                paymentMethod,
                status: 'Confirmed',
                timestamp: new Date().toLocaleString(),
                estimatedDelivery: new Date(Date.now() + 2 * 60 * 60 * 1000).toLocaleString() // 2 hours from now
            };

            orders.unshift(order);
            saveOrdersToStorage();

            // Clear cart
            cart = [];
            updateCartDisplay();
            saveCartToStorage();

            closeModal('checkoutModal');
            
            alert(`Order confirmed! Order ID: ${orderId}\nEstimated delivery: ${order.estimatedDelivery}`);
        }

        // Redirect to order history page
        function redirectToOrderHistory() {
            if (!currentUser) {
                alert('Please login to view order history');
                return;
            }
            
            // For now, show alert since we can't navigate to another page in artifacts
            window.location.href = 'orders.html';
            
            // In a real application, you would use:
            // window.location.href = 'orders.html';
        }

        // Handle reorder items when returning from order history
        function handleReorderItems() {
            try {
                let reorderData = null;
                if (typeof Storage !== "undefined") {
                    reorderData = localStorage.getItem('vendorConnect_reorder');
                    if (reorderData) {
                        localStorage.removeItem('vendorConnect_reorder');
                        const items = JSON.parse(reorderData);
                        
                        // Add items to cart
                        items.forEach(item => {
                            const existingItem = cart.find(cartItem => 
                                cartItem.productId === item.productId && cartItem.supplierId === item.supplierId
                            );
                            
                            if (existingItem) {
                                existingItem.quantity += item.quantity;
                            } else {
                                cart.push(item);
                            }
                        });
                        
                        updateCartDisplay();
                        saveCartToStorage();
                        
                        alert(`${items.length} items added to your cart from your previous order!`);
                        return;
                    }
                }
                
                if (window.reorderData) {
                    const items = window.reorderData;
                    
                    // Add items to cart
                    items.forEach(item => {
                        const existingItem = cart.find(cartItem => 
                            cartItem.productId === item.productId && cartItem.supplierId === item.supplierId
                        );
                        
                        if (existingItem) {
                            existingItem.quantity += item.quantity;
                        } else {
                            cart.push(item);
                        }
                    });
                    
                    updateCartDisplay();
                    saveCartToStorage();
                    window.reorderData = null;
                    
                    alert(`${items.length} items added to your cart from your previous order!`);
                }
            } catch (e) {
                console.log('No reorder data available');
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Initialize app when page loads
        window.addEventListener('load', initApp);
    </script>
</body>
</html>